Uniform Instruction Format Proposal
===================================

This is a proposal to have a 64-bit instruction that all shorter instructions
can be translated to, such that the internal representation used in a CPU can
be this 64-bit format.

The instruction format is designed for ease of decoding, rather than encoding
density.

Conventions
===========

Conventions used in this document:
- Bits are numbered starting from 0 at the LSB, so bit 3 is 1 in the integer 8.
- Bit ranges are inclusive on both ends, so 5:3 means bits 5, 4, and 3.

Operations work on variable-length vectors of sub-vectors, where each sub-vector
has a length *svlen*, and an element type *etype*. When the vectors are stored
in registers, all elements are packed so that there is no padding in-between
elements of the same vector. The number of bytes in a sub-vector, *svsz*, is the
product of *svlen* and the element size in bytes.

Register Fields
===============

+---------------------+-----------------+
| 7                   | 6:0             |
+=====================+=================+
| Float (1) / Int (0) | Register Number |
+---------------------+-----------------+

Predicate (pred)
================

+-------------------+---------------------------+
| 5                 | 4:0                       |
+===================+===========================+
| Matched Bit Value | Predicate Register (preg) |
+-------------------+---------------------------+

+----------+----------------+
| Encoding |                |
+==========+================+
| 000000   | *Unpredicated* |
+----------+----------------+
| 100000   | *Reserved*     |
+----------+----------------+
| 000001   | ``!x1``        |
| \.\.\.   | \.\.\.         |
| 011111   | ``!x31``       |
+----------+----------------+
| 100001   | x1             |
| \.\.\.   | \.\.\.         |
| 111111   | x31            |
+----------+----------------+

Sub-Vector Length (svlen) Field Encoding
========================================

+----------------+-------+
| svlen Encoding | Value |
+================+=======+
| 00             | 4     |
+----------------+-------+
| 01             | 1     |
+----------------+-------+
| 10             | 2     |
+----------------+-------+
| 11             | 3     |
+----------------+-------+

Sub-Vector Element Type (svet) Field Encoding
=============================================

Encoding chosen for ease of decoding

+-----------------+----------------------------------+
| svet Encoding   | Value                            |
+=================+==================================+
| 0000            | u8                               |
+-----------------+----------------------------------+
| 0001            | i8                               |
+-----------------+----------------------------------+
| 0010            | u16                              |
+-----------------+----------------------------------+
| 0011            | i16                              |
+-----------------+----------------------------------+
| 0100            | u32                              |
+-----------------+----------------------------------+
| 0101            | i32                              |
+-----------------+----------------------------------+
| 0110            | u64                              |
+-----------------+----------------------------------+
| 0111            | i64                              |
+-----------------+----------------------------------+
| 1000            | u128 (only on SV128)             |
+-----------------+----------------------------------+
| 1001            | i128 (only on SV128)             |
+-----------------+----------------------------------+
| 1010            | f16                              |
+-----------------+----------------------------------+
| 1011            | *Reserved*                       |
+-----------------+----------------------------------+
| 1100            | f32                              |
+-----------------+----------------------------------+
| 1101            | *Reserved*                       |
+-----------------+----------------------------------+
| 1110            | f64                              |
+-----------------+----------------------------------+
| 1111            | f128 (only with Q extension)     |
+-----------------+----------------------------------+

vs#/vd Fields' Encoding
=======================

+--------+----------+----------------------------------------------------------+
| vs#/vd | Mnemonic | Meaning                                                  |
+========+==========+==========================================================+
| 0      | S        | the rs#/rd field specifies a scalar (single sub-vector)  |
+--------+----------+----------------------------------------------------------+
| 1      | V        | the rs#/rd field specifies a vector                      |
+--------+----------+----------------------------------------------------------+

If a vs#/vd field is not present, it is as if it was present with a value that
is the bitwise-or of all present vs#/vd fields.

Instruction Format
==================

All format names are prefixed with UIF64 (Uniform Instruction Format 64-bit).

All reserved values must be 0.

TODO: add immediates to UIF64I and add missing formats

Bits 49:46 are chosen so the vectorizing unit just has to check those 4 bits to
know if vectorizing is needed and which fields to increment.

+----------+---------+----+----+----+----+----+----+----+----+----+----+----+----+----+------------+------------+------------+------------+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+------------+---------+
| Format   | 63      | 62 | 61 | 60 | 59 | 58 | 57 | 56 | 55 | 54 | 53 | 52 | 51 | 50 | 49         | 48         | 47         | 46         | 45 | 44 | 43 | 42 | 41 | 40 | 39 | 38 | 37 | 36 | 35 | 34 | 33 | 32 | 31 | 30 | 29 | 28 | 27 | 26 | 25 | 24 | 23 | 22 | 21 | 20 | 19 | 18 | 17 | 16 | 15 | 14 | 13 | 12 | 11 | 10 | 9  | 8  | 7          | 6:0     |
+==========+=========+====+====+====+====+====+====+====+====+====+====+====+====+====+============+============+============+============+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+====+============+=========+
| UIF64STR | imm[11:9]         | Opcode                 | svet              | svlen   | *Reserved* | vs2        | vs1        | *Reserved* | pred                        | rstride                               | rs2                                   | rs1                                   | imm[7:0]                              | imm[8]     | 0111111 |
+----------+                   +                        +                   +         +            +------------+            +------------+                             +                                       +----+----+----+----+----+----+----+----+                                       +----+----+----+----+----+----+----+----+            +         +
| UIF64LDR |                   |                        |                   |         |            | *Reserved* |            | vd         |                             |                                       | imm[7:0]                              |                                       | rd                                    |            |         |
+----------+                   +                        +                   +         +            +------------+            +------------+                             +----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+                                       +----+----+----+----+----+----+----+----+            +         +
| UIF64STI |                   |                        |                   |         |            | vs2        |            | *Reserved* |                             | immstride                             | rs2                                   |                                       | imm[7:0]                              |            |         |
+----------+                   +                        +                   +         +            +------------+            +------------+                             +                                       +----+----+----+----+----+----+----+----+                                       +----+----+----+----+----+----+----+----+            +         +
| UIF64LDI |                   |                        |                   |         |            | *Reserved* |            | vd         |                             |                                       | imm[7:0]                              |                                       | rd                                    |            |         |
+----------+---------+----+----+----+----+----+----+----+                   +         +------------+------------+            +            +                             +----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+                                       +                                       +------------+         +
| UIF64R4  | Opcode                                     |                   |         | vs3        | vs2        |            |            |                             | rs3                                   | rs2                                   |                                       |                                       | *Reserved* |         |
+----------+                                            +                   +         +------------+            +            +            +                             +----+----+----+----+----+----+----+----+                                       +                                       +                                       +            +         +
| UIF64R   |                                            |                   |         | *Reserved* |            |            |            |                             | *Reserved*                            |                                       |                                       |                                       |            |         |
+----------+---------+----+----+----+----+----+----+----+                   +         +            +------------+            +            +                             +----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+                                       +                                       +            +         +
| UIF64I   | imm[16] | Opcode                           |                   |         |            | *Reserved* |            |            |                             | imm[15:12]        | imm[11:8]         | imm[7:0]                              |                                       |                                       |            |         |
+----------+---------+                                  +                   +         +            +            +------------+            +                             +                   +----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+                                       +            +         +
| UIF64U   | imm[36] |                                  |                   |         |            |            | *Reserved* |            |                             |                   | imm[35:32]        | imm[31:24]                            | imm[23:16]                            |                                       |            |         |
+----------+---------+----+----+----+----+----+----+----+                   +         +            +            +            +------------+----+----+----+----+----+----+                   +----+----+----+----+----+----+----+----+----+----+----+----+                                       +                                       +            +         +
| UIF64LI  | imm[31:30]   | Opcode                      |                   |         |            |            |            | *Reserved* | imm[29:24]                  |                   | imm[11:8]         | imm[7:0]                              |                                       |                                       |            |         |
+----------+---------+----+----+----+----+----+----+----+                   +         +            +            +            +            +----+----+----+----+----+----+                   +                   +----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+            +         +
| UIF64B   | imm[16] | Opcode                           |                   |         |            |            |            |            | *Reserved*                  |                   |                   | rs2                                   | rs1                                   | imm[7:0]                              |            |         |
+----------+---------+----+----+----+----+----+----+----+----+----+----+----+----+----+------------+------------+------------+------------+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+----+------------+---------+


Opcode Table
============

+---------------------------+----------+-----------+-----------+-----------+-------------+
| Instruction               | Format   | Opcode[7] | Opcode[6] | Opcode[5] | Opcode[4:0] |
+===========================+==========+===========+===========+===========+=============+
| Load/Load-Strided         | UIF64LDI | --        | --        | --        | 00000       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| Load-Strided              | UIF64LDR | --        | --        | --        | 00001       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (custom-0)     | --       | --        | --        | --        | 00010       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: MISC-MEM           | --       | --        | --        | --        | 00011       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: OP-IMM             | UIF64I   | --        | X         | X         | 00100       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| AUIPC/AUIPC+ADDI          | UIF64LI  | --        | --        | 0         | 00101       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| CALL (rd=x1)              | UIF64LI  | --        | --        | 1         | 00101       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 00110       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 00111       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| Store/Store-Strided       | UIF64STI | --        | --        | --        | 01000       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| Store-Strided             | UIF64STR | --        | --        | --        | 01001       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (custom-1)     | --       | --        | --        | --        | 01010       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: AMO                | --       | --        | --        | --        | 01011       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: OP                 | --       | --        | --        | --        | 01100       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| LUI/LUI+ADDI              | UIF64LI  | --        | --        | 0         | 01101       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| TAIL (rd=x6)              | UIF64LI  | --        | --        | 1         | 01101       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 01110       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 01111       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: MADD               | UIF64R4  | X         | X         | X         | 10000       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: MSUB               | UIF64R4  | X         | X         | X         | 10001       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: NMSUB              | UIF64R4  | X         | X         | X         | 10010       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: NMADD              | UIF64R4  | X         | X         | X         | 10011       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 10100       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (standard)     | --       | --        | --        | --        | 10101       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (custom-2)     | --       | --        | --        | --        | 10110       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 10111       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: BRANCH             | UIF64B   | --        | X         | X         | 11000       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: JALR               | UIF64I   | --        | X         | X         | 11001       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (standard)     | --       | --        | --        | --        | 11010       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: JAL                | UIF64LI  | --        | --        | X         | 11011       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| FIXME: SYSTEM             | --       | --        | --        | --        | 11100       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (standard)     | --       | --        | --        | --        | 11101       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved* (custom-3)     | --       | --        | --        | --        | 11110       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
| *Reserved*                | --       | --        | --        | --        | 11111       |
+---------------------------+----------+-----------+-----------+-----------+-------------+
